# Oppsett av automatisk bygg gjennom Azure pipelines
# Alle tags bygges og publiseres til Azure Container Registry
# - YAML-skjema https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema
# - Innebygde variable https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml
# - Bruke variable https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch
# - Caching https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops
# - Innebygde tasks https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/?view=azure-devops
# - Cache task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/cache?view=azure-devops
# - Maven task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/maven?view=azure-devops
# - Docker task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/docker?view=azure-devops
# - Bash task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/bash?view=azure-devops
# - Maven help:evaluate https://maven.apache.org/plugins/maven-help-plugin/evaluate-mojo.html

trigger:
  tags:
    include:
      - refs/tags/*

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  TAG: $(Build.SourceBranchName)

steps:
  - task: DownloadSecureFile@1
    displayName: 'Download Maven'
    name: maven
    inputs:
      secureFile: 'apache-maven-3.6.3-bin.tar.gz'
  - task: ExtractFiles@1
    displayName: 'Extract maven'
    inputs:
      archiveFilePatterns: '$(maven.secureFilePath)'
      cleanDestinationFolder: false
  - task: CmdLine@2
    inputs:
      script: |
        echo $AGENT_WORKFOLDER
        ls -1 $AGENT_WORKFOLDER
        ls -1 $AGENT_WORKFOLDER/1
        ls -1 $AGENT_WORKFOLDER/1/s
        echo $AGENT_BUILDDIRECTORY
        ls -1 $AGENT_BUILDDIRECTORY
        ls -1 $AGENT_BUILDDIRECTORY/s

  - task: Bash@3
    displayName: 'Get maven project version'
    inputs:
      targetType: inline
      script: |
        'sudo cat apache-maven-3.6.3/README.txt'
        'MAVEN_PROJECT_VERSION=$(/home/vsts/work/1/s/apache-maven-3.6.3/bin/mvn help:evaluate -Dexpression=project.version -q -DforceStdout)'
        'echo "##vso[task.setvariable variable=TAG]$MAVEN_PROJECT_VERSION"'
  - task: Cache@2
    displayName: Cache Maven local repo
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: $(MAVEN_CACHE_FOLDER)
  - task: Maven@3
    displayName: 'Maven package'
    inputs:
      goals: 'package'
      mavenOptions: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) -Dhttp.keepAlive=false -Dmaven.wagon.http.retryHandler.count=3'
      jdkVersionOption: 1.8
  - task: Docker@2
    displayName: 'Login to Azure Container Registry'
    inputs:
      command: 'login'
      containerRegistry: 'prodacrPremium1'
  - task: Docker@2
    displayName: 'Docker build and push'
    inputs:
      command: 'buildAndPush'
      repository: 'eformidling/efm-sr-proxy'
      tags: $(TAG)

# Oppsett av automatisk bygg gjennom Azure pipelines
# Alle tags bygges og publiseres til Azure Container Registry
# - YAML-skjema https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema
# - Innebygde variable https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml
# - Caching https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops
# - Innebygde tasks https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/?view=azure-devops
# - Cache task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/cache?view=azure-devops
# - Maven task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/maven?view=azure-devops
# - Docker task https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/docker?view=azure-devops

trigger:
  tags:
    include:
      - refs/tags/*

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'

steps:
  - task: Cache@2
    displayName: Cache Maven local repo
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: $(MAVEN_CACHE_FOLDER)
  - task: Maven@3
    displayName: 'Maven package'
    inputs:
      goals: 'package'
      #publishJUnitResults: false
      mavenOptions: '$(MAVEN_OPTS) -Dhttp.keepAlive=false -Dmaven.wagon.http.retryHandler.count=3'
      jdkVersionOption: 1.8
  - task: Docker@2
    displayName: 'Login to Azure Container Registry'
    inputs:
      command: 'login'
      containerRegistry: 'prodacrPremium1'
  - task: Docker@2
    displayName: 'Docker build and push'
    inputs:
      command: 'buildAndPush'
      repository: 'eformidling/efm-sr-proxy'
      tags: $(Build.SourceBranchName)
